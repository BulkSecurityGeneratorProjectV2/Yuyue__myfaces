<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE project [
    <!ENTITY tomcat-build SYSTEM "file:../tomcat/tomcat-build.xmlf">
]>

<project name="myfaces-tagunit-tests" default="tagunit">

    <property environment="env"/>

    <!-- Constants -->
    <property name="project.dir" location="${basedir}/../.."/>
    <property name="tagunit.web" location="${project.dir}/webapps/tagunit/web"/>
	<property name="webapp.name" value="myfaces-tagunit-tests"/>

    <!-- Properties -->
    <property file="../build.local.properties"/>
    <property file="../build.default.properties"/>

    <!-- Temporary dir. May be overridden in build.properties -->
    <property name="temp.dir" location="${env.TEMP}"/>

    <!-- Output dirs and files -->
    <property name="tests.war" location="${temp.dir}/myfaces-tagunit-tests.war"/>

    <!-- Tomcat -->
    <property name="tomcat.war.file" location="${tests.war}"/>
    <property name="tomcat.context.path" value="/myfaces-tagunit-tests"/>

    <target name="tagunit" depends="-war">
        <antcall target="tomcat-deploy-app"/>
        <antcall target="-tomcat-tagunit-tests"/>
        <antcall target="tomcat-undeploy-app"/>
    </target>

	<target name="clean"
            description="Deletes all files that were built">
        <delete file="${tests.war}"/>
    </target>


    <target name="-war"
            depends="-myfaces-jar"
    	    description="creates the taglib-test war file">
        <mkdir dir="${temp.dir}"/>
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm" locale="en"/>
        </tstamp>
        <war destfile="${tests.war}"
             webxml="${basedir}/web.xml">
            <manifest>
                <section name="myfaces.sourceforge.net">
                    <attribute name="Implementation-Title" value="MyFaces - Tagunit Tests"/>
                    <attribute name="Implementation-Version" value="${TODAY}"/>
                    <attribute name="Implementation-Vendor" value="MyFaces Project Team"/>
                </section>
            </manifest>
            <lib file="${commons-codec.jar}"/>
            <lib file="${commons-el.jar}"/>
            <lib file="${commons-logging.jar}"/>
            <lib file="${jsp-api.jar}"/>
            <lib file="${jstl.jar}"/>
            <lib file="${myfaces.jar}"/>
            <lib file="${log4j.jar}"/>
            <lib dir="${tagunit.lib.dir}">
                <include name="*.jar"/>
            </lib>
            <fileset dir="${tagunit.web}" excludes="WEB-INF/**" />
        </war>
    </target>

	<taskdef file="${basedir}/TagUnitTasks.properties">
        <classpath>
            <pathelement path="${tagunit.lib.dir}/tagunit.jar"/>
        </classpath>
    </taskdef>

	<target name="-tomcat-tagunit-tests"
            description="run the tag unit tests">
      <tagunit url="http://${tomcat.server}:${tomcat.port}/${webapp.name}/test/servlet/RunTests?uri=/test/myfaces_html.jsp"
               ignoreWarnings="true" stopOnFail="false"/>	
      <tagunit url="http://${tomcat.server}:${tomcat.port}/${webapp.name}/test/servlet/RunTests?uri=/test/myfaces_core.jsp"
               ignoreWarnings="true" stopOnFail="false"/>	
      <tagunit url="http://${tomcat.server}:${tomcat.port}/${webapp.name}/test/servlet/RunTests?uri=/test/myfaces_ext.jsp"
               ignoreWarnings="true" stopOnFail="false"/>	
	</target>


    &tomcat-build;


    <target name="-myfaces-jar" description="create myfaces.jar if necessary" >
        <available file="${myfaces.jar}" property="myfaces.jar.available"/>
        <antcall target="-create-myfaces-jar"/>
    </target>

    <target name="-create-myfaces-jar" unless="myfaces.jar.available"
            description="creates myfaces.jar via main buildfile" >
        <ant dir="${project.dir}/build" antfile="build.xml" target="myfaces-jar" inheritall="false"/>
    </target>

</project>