<?xml version="1.0" encoding="iso-8859-1"?>
<project name="myfaces-release" default="all" >

    <property environment="env"/>

    <!-- Constants -->
    <property name="project.dir" location="${basedir}/.."/>
    <property name="build.dir" location="${project.dir}/build"/>
    <property name="nightly.dir" location="${build.dir}/nightly"/>
    <property name="dist.dir" location="${build.dir}/dist"/>
    <property name="release.dir" location="${basedir}/release"/>
    <property name="jsfapi.src" location="${project.dir}/src/jsfapi"/>
    <property name="share.src" location="${project.dir}/src/share"/>
    <property name="myfaces.src" location="${project.dir}/src/myfaces"/>
    <property name="components.src" location="${project.dir}/src/components"/>
    <property name="cactus.src" location="${project.dir}/src/cactus"/>
    <property name="junit.src" location="${project.dir}/src/junit"/>
    <property name="tlds.dir" location="${project.dir}/tlds"/>
    <property name="doc.dir" location="${project.dir}/doc"/>
    <property name="webapp.dist.dir" location="${dist.dir}/webapp"/>
    <property name="conf.dir" location="${project.dir}/conf"/>
    <property name="apps.dir" location="${project.dir}/webapps"/>
    <property name="wml.src" location="${project.dir}/src/wml"/>
    <property name="xdoclet.src" location="${project.dir}/src/xdoclet"/>
    <property name="generated.src" location="${project.dir}/src/generated"/>
    <property file="sign.script" location="${release.dir}/sign.sh"/>

    <!-- Properties -->
    <property file="build.local.properties"/>
    <property file="build.default.properties"/>
    <property file="manifest.properties"/>

    <property name="release.version" value="${manifest.impl.version}"/>
    <property name="src.release.bundle" value="myfaces-${release.version}-src"/>
    <property name="bin.release.bundle" value="myfaces-${release.version}"/>
    <property name="app.release.bundle" value="myfaces-${release.version}-app"/>

    <!-- Temporary dir. May be overridden in build.local.properties -->
    <property name="temp.dir" location="${env.TEMP}"/>

    <property name="api.classes" location="${temp.dir}/myfaces-api/classes"/>
    <property name="share.classes" location="${temp.dir}/myfaces-share/classes"/>
    <property name="wml.classes" location="${temp.dir}/myfaces-wml/classes"/>
    <property name="xdoclet.classes" location="${temp.dir}/myfaces-xdoclet/classes"/>
    <property name="impl.classes" location="${temp.dir}/myfaces-impl/classes"/>
    <property name="components.classes" location="${temp.dir}/myfaces-components/classes"/>

    <property name="resolved-tlds.dir" location="${temp.dir}/myfaces-tlds"/>

    <!-- classpath for compiling api classes -->
    <path id="jsfapi.class.path">
        <pathelement location="${servlet-jsp.jar}"/>
        <pathelement location="${jstl.jar}"/>
    </path>

    <!-- classpath for compiling shared classes -->
    <path id="share.class.path">
        <pathelement location="${servlet-jsp.jar}"/>
        <pathelement location="${jstl.jar}"/>
        <pathelement location="${jsp-2.0.jar}"/>
        <pathelement location="${commons-logging.jar}"/>
        <pathelement location="${commons-el.jar}"/>
        <pathelement location="${api.classes}"/>
    </path>

    <!-- classpath for compiling impl classes -->
    <path id="myfaces.class.path">
        <pathelement location="${servlet-jsp.jar}"/>
        <pathelement location="${jstl.jar}"/>
        <pathelement location="${jsp-2.0.jar}"/>
        <pathelement location="${commons-logging.jar}"/>
        <pathelement location="${commons-el.jar}"/>
        <pathelement location="${commons-codec.jar}"/>
        <pathelement location="${commons-beanutils.jar}"/>
        <pathelement location="${commons-collections.jar}"/>
        <pathelement location="${commons-digester.jar}"/>
        <pathelement location="${portlet.jar}"/>
        <pathelement location="${api.classes}"/>
        <pathelement location="${share.classes}"/>
    </path>

    <!-- classpath for compiling component classes -->
    <path id="components.class.path">
        <pathelement location="${servlet-jsp.jar}"/>
        <pathelement location="${jstl.jar}"/>
        <pathelement location="${jsp-2.0.jar}"/>
        <pathelement location="${commons-logging.jar}"/>
        <pathelement location="${commons-el.jar}"/>
        <pathelement location="${commons-validator.jar}"/>
        <pathelement location="${jakarta-oro.jar}"/>
        <pathelement location="${struts.jar}"/>
        <pathelement location="${commons-beanutils.jar}"/>
        <pathelement location="${commons-fileupload.jar}"/>
        <pathelement location="${commons-digester.jar}"/>
        <pathelement location="${commons-beanutils.jar}"/>
        <pathelement location="${api.classes}"/>
        <pathelement location="${share.classes}"/>
    </path>

    <!-- classpath for compiling wmlRenderKit classes -->
	<path id="wml.classpath.path">
	    <pathelement location="${commons-codec.jar}"/>
	    <pathelement location="${commons-beanutils.jar}"/>
	    <pathelement location="${commons-collections.jar}"/>
	    <pathelement location="${commons-digester.jar}"/>
	    <pathelement location="${commons-logging.jar}"/>
        <pathelement location="${api.classes}"/>
        <pathelement location="${share.classes}"/>
        <pathelement location="${impl.classes}"/>
	    <pathelement location="${jstl.jar}"/>
	    <pathelement location="${build.dir}/WEB-INF/classes/"/>
	    <pathelement location="${jsp-2.0.jar}"/>
	    <pathelement location="${servlet-jsp.jar}"/>
	</path>


    <!-- classpath for javadoc creation -->
    <path id="javadoc.class.path">
        <pathelement location="${servlet-jsp.jar}"/>
        <pathelement location="${jsp-2.0.jar}"/>
        <pathelement location="${jstl.jar}"/>
        <pathelement location="${commons-codec.jar}"/>
        <pathelement location="${commons-logging.jar}"/>
        <pathelement location="${commons-el.jar}"/>
        <pathelement location="${jakarta-oro.jar}"/>
        <pathelement location="${commons-validator.jar}"/>
        <pathelement location="${commons-fileupload.jar}"/>
        <pathelement location="${myfaces.jar}"/>
        <pathelement location="${myfaces-jsf-api.jar}"/>
        <pathelement location="${commons-beanutils.jar}"/>
        <pathelement location="${commons-collections.jar}"/>
        <pathelement location="${commons-digester.jar}"/>
    </path>

	  <path id="xdoclet.classpath">
	    <pathelement location="${xdoclet.jar}"/>
	    <pathelement location="${xjavadoc.jar}"/>
	    <pathelement location="${commons-collections.jar}"/>
	    <pathelement location="${commons-logging.jar}"/>
	  </path>

    <target name="myfaces-jsf-api-jar"
            description="builds the myfaces-jsf-api.jar file"
            depends="-compile-api">
        <!-- timestamp for the manifest -->
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm z"/>
        </tstamp>

        <!-- build the jar -->
        <jar destfile="${myfaces-jsf-api.jar}">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>

            <!-- classes -->
            <fileset dir="${api.classes}"
                     includes="**/*.class"/>
        </jar>

    </target>

    <target name="myfaces-impl-jar"
            description="builds the myfaces-impl.jar file"
            depends="-compile-share,-compile-impl,-compile-components,myfaces-jsf-api-jar,resolve-tld-entities" >
        <!-- timestamp for the manifest -->
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm z"/>
        </tstamp>

        <!-- build the jar -->
        <jar destfile="${myfaces-impl.jar}">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>

            <!-- classes -->
            <fileset dir="${share.classes}"
                     includes="**/*.class"/>
            <fileset dir="${impl.classes}"
                     includes="**/*.class"/>
            <!-- properties, DTDs, XMLs -->
            <fileset dir="${myfaces.src}"
                     includes="**"
                     excludes="**/*.java
                               **/package.html"/>
            <!-- TLDs -->
            <zipfileset dir="${resolved-tlds.dir}"
                        includes="*.tld"
                        prefix="META-INF/"/>
            <!-- faces-config.xml -->
            <zipfileset dir="${project.dir}/conf"
                        includes="faces-config.xml"
                        prefix="META-INF/"/>
        </jar>

    </target>

    <target name="myfaces-extensions-jar"
            description="builds the myfaces-extensions.jar file"
            depends="-compile-share,
                     -compile-components,
                     resolve-tld-entities" >
        <!-- timestamp for the manifest -->
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm z"/>
        </tstamp>

        <!-- build the jar -->
        <jar destfile="${myfaces-extensions.jar}">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title.components}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>

            <!-- classes -->
            <fileset dir="${share.classes}"
                     includes="**/*.class"/>
            <fileset dir="${components.classes}"
                     includes="**/*.class"/>
            <!-- TLDs -->
            <zipfileset dir="${resolved-tlds.dir}"
                        includes="myfaces_ext.tld,myfaces_ext_sf.tld"
                        prefix="META-INF/"/>
            <!-- faces-config.xml -->
            <zipfileset dir="${project.dir}/conf"
                        includes="faces-config.xml"
                        prefix="META-INF/"/>
            <!-- components_resources -->
            <fileset    dir="${components.src}"
                        includes="**/resource/**"/>
            <fileset    dir="${components.classes}"
                        includes="**/*.properties"/>
        </jar>

    </target>

    <target name="myfaces-jar"
            description="builds the myfaces.jar file with the complete myfaces libraries"
            depends="-compile-share,-compile-impl,-compile-components,resolve-tld-entities" >
        <!-- timestamp for the manifest -->
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm z"/>
        </tstamp>

        <!-- build the jar -->
        <jar destfile="${myfaces.jar}">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>

            <!-- classes -->
            <fileset dir="${api.classes}"
                     includes="**/*.class"/>
            <fileset dir="${share.classes}"
                     includes="**/*.class"/>
            <fileset dir="${impl.classes}"
                     includes="**/*.class"/>
            <fileset dir="${components.classes}"
                     includes="**/*.class"/>

            <!-- properties, DTDs, XMLs -->
            <fileset dir="${myfaces.src}"
                     includes="**"
                     excludes="**/*.java
                               **/package.html"/>
            <!-- TLDs -->
            <zipfileset dir="${resolved-tlds.dir}"
                        includes="*.tld"
                        prefix="META-INF/"/>
            <!-- faces-config.xml -->
            <zipfileset dir="${project.dir}/conf"
                        includes="faces-config.xml"
                        prefix="META-INF/"/>
            <!-- components_resources -->
            <fileset    dir="${components.src}"
                        includes="**/resource/**"/>
            <fileset    dir="${components.classes}"
                        includes="**/*.properties"/>
        </jar>

    </target>


    <target name="javadoc"
            description="creates javadoc for MyFaces classes"
            depends="myfaces-jar" >
        <mkdir dir="${doc.dir}/javadoc"/>
        <javadoc destdir="${doc.dir}/javadoc"
                 packagenames="org.apache.myfaces.*"
                 classpathref="javadoc.class.path"
                 failonerror="true"
        	     Windowtitle="Apache MyFaces API Documentation">
        	<sourcepath>
           		<pathelement location="${myfaces.src}"/>
           		<pathelement location="${share.src}"/>
           		<pathelement location="${components.src}"/>
        		<pathelement location="${wml.src}"/>
               	<pathelement location="${xdoclet.src}"/>
		   	</sourcepath>
        </javadoc>
    </target>

    <target name="tlddoc"
            description="creates tlddoc for the extension tld"
            depends="resolve-tld-entities,codegen" >
        <mkdir dir="${doc.dir}/tlddoc"/>
        <java fork="true" jar="${tlddoc.jar}" failonerror="true">
            <arg line="-doctitle 'Tag library for Apache MyFaces'" />
            <arg line="-d ${doc.dir}/tlddoc"/>
            <arg value="${resolved-tlds.dir}/myfaces_ext.tld"/>
            <arg value="${generated.src}/myfaces_wap.tld"/>
		</java>
    </target>

    <target name="prepare-bin-release" depends="prepare">

        <copy todir="${temp.dir}/${bin.release.bundle}/doc">
            <fileset dir="${doc.dir}"/>
        </copy>
        <copy todir="${temp.dir}/${bin.release.bundle}/conf">
            <fileset dir="${conf.dir}"/>
        </copy>
        <copy file="${commons-codec.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-logging.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-el.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-fileupload.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-validator.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${jakarta-oro.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-codec.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${jstl.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${jsp-2.0.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-digester.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-beanutils.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${commons-collections.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces-jsf-api.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces-impl.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces-extensions.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces-wap.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>
        <copy file="${myfaces-xdoclet.jar}" todir="${temp.dir}/${bin.release.bundle}/lib"/>

    </target>

    <target name="bin-release"
            depends="prepare, myfaces-jsf-api-jar, myfaces-impl-jar, myfaces-extensions-jar, myfaces-jar, myfaces-wap-jar, javadoc, tlddoc, prepare-bin-release"
            description="creates the binary release file myfaces-x.x.x.tgz (don't forget to adjust manifest.properties!)">

        <property name="bin.release.tgz" value="${release.dir}/${bin.release.bundle}.tgz"/>
        <property name="bin.release.zip" value="${release.dir}/${bin.release.bundle}.zip"/>

        <tar destfile="${bin.release.tgz}" compression="gzip" >
             <tarfileset prefix="${bin.release.bundle}" dir="${temp.dir}/${bin.release.bundle}"/>
        </tar>
        <zip destfile="${bin.release.zip}" compress="true">
            <zipfileset prefix="${bin.release.bundle}" dir="${temp.dir}/${bin.release.bundle}"/>
        </zip>
        <checksum file="${bin.release.tgz}" forceOverwrite="yes" fileext=".md5"/>
        <checksum file="${bin.release.zip}" forceOverwrite="yes" fileext=".md5"/>

        <!-- generate/append script for pgp signing of bundle -->
        <echo file="${sign.script}" append="true">
        gpg -o ${bin.release.tgz}.asc --detach-sig ${bin.release.tgz}
        gpg --verify ${bin.release.tgz}.asc ${bin.release.tgz}
        gpg -o ${bin.release.zip}.asc --detach-sig ${bin.release.zip}
        gpg --verify ${bin.release.zip}.asc ${bin.release.zip}
        </echo>                

    </target>

    <!-- get all the files in one location so they can be bundled -->
    <target name="prepare-src-release" depends="prepare">
        <copy todir="${temp.dir}/${src.release.bundle}/build">
            <fileset dir="${build.dir}"
                     excludes= "**/codegen/**,
                                **/develop/**,
                                **/temp/**,
                                **tmp/**,
                                **/nightly/**,
                                **/release/**,
                                **/dist/**,
                                **/site/**,
                                **/webapp/**"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/conf">
            <fileset dir="${conf.dir}" excludes="develop-web.xml"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/doc">
            <fileset dir="${doc.dir}" excludes="javadoc/**/*,tlddoc/**/*"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/jsfapi">
            <fileset dir="${jsfapi.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/share">
            <fileset dir="${share.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/myfaces">
            <fileset dir="${myfaces.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/wml">
            <fileset dir="${wml.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/xdoclet">
            <fileset dir="${xdoclet.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/components">
            <fileset dir="${components.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/cactus">
            <fileset dir="${cactus.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/src/junit">
            <fileset dir="${junit.src}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/tlds">
            <fileset dir="${tlds.dir}"/>
        </copy>
        <copy todir="${temp.dir}/${src.release.bundle}/webapps">
            <fileset dir="${apps.dir}" excludes="**/lib/**, **/classes/**"/>
        </copy>
    </target>

    <target name="src-release"
            depends="prepare-src-release"
            description="creates the source release file myfaces-x.x.x-src.tgz (don't forget to adjust manifest.properties!)">

        <property name="src.release.tgz" value="${release.dir}/${src.release.bundle}.tgz"/>
        <property name="src.release.zip" value="${release.dir}/${src.release.bundle}.zip"/>
        
        <tar destfile="${src.release.tgz}" compression="gzip">
             <tarfileset prefix="${src.release.bundle}" dir="${temp.dir}/${src.release.bundle}"/>
        </tar>
        <zip destfile="${src.release.zip}" compress="true">
            <zipfileset prefix="${src.release.bundle}" dir="${temp.dir}/${src.release.bundle}"/>
        </zip>
        <checksum file="${src.release.tgz}" forceOverwrite="yes" fileext=".md5"/>
        <checksum file="${src.release.zip}" forceOverwrite="yes" fileext=".md5"/>

        <!-- generate/append script for pgp signing of bundle -->
        <echo file="${sign.script}" append="true">
        gpg -o ${src.release.tgz}.asc --detach-sig ${src.release.tgz}
        gpg --verify ${src.release.tgz}.asc ${src.release.tgz}
        gpg -o ${src.release.zip}.asc --detach-sig ${src.release.zip}
        gpg --verify ${src.release.zip}.asc ${src.release.zip}
        </echo>                

    </target>

    <target name="all" depends="release" description="builds all release files"/>

	<target name="all-tests"
            depends="myfaces-jar"
            description="run all the automated tests - tomcat 5.0.18 or better needs to be running on port 8080 for this to work">
		<ant dir="${project.dir}/build/junit" antfile="build.xml" inheritall="false"
		     target="junit"/>
		<ant dir="${project.dir}/build/tagunit-webapp" antfile="build.xml" inheritall="false"
		     target="tagunit"/>
		<ant dir="${project.dir}/build/cactus-webapp" antfile="build.xml" inheritall="false"
		     target="cactus"/>
    </target>

    <target name="clean"
        description="deletes all files that were built (including examples and tagunit)">
        <delete quiet="true" failonerror="false" includeEmptyDirs="true">
            <fileset file="${myfaces-jsf-api.jar}" />
            <fileset file="${myfaces-impl.jar}" />
            <fileset file="${myfaces-extensions.jar}" />
            <fileset file="${myfaces.jar}" />
            <fileset file="${myfaces-wap.jar}" />
            <fileset file="${myfaces-xdoclet.jar}" />
            <fileset file="${project.dir}/myfaces-*.tgz" />
            <fileset dir="${doc.dir}/javadoc" />
            <fileset dir="${doc.dir}/tlddoc" />
        	<fileset dir="${wml.classes}"/>
			<fileset dir="${generated.src}"/>
        	<fileset dir="${api.classes}"/>
            <fileset dir="${share.classes}"/>
            <fileset dir="${impl.classes}"/>
            <fileset dir="${components.classes}"/>
            <fileset dir="${resolved-tlds.dir}"/>     <!-- in case of interrupted builds -->
        	<fileset dir="${project.dir}/src"> <!-- Temp files created by the IDE -->
				<include name="**/*.class"/>
        	</fileset>
        </delete>

        <delete dir="${dist.dir}"/>
        <delete dir="${release.dir}"/>
        <delete dir="${resolved-tlds.dir}"/>
        <delete dir="${temp.dir}"/>

        <!-- clean up application build stuff as well -->
        <ant antfile="build-webapps.xml" inheritall="false" target="clean"/>
    </target>

    <target name="clean-all"
            description="deletes all files that were built (including also all sub buildfiles)"
            depends="clean" >
        <ant dir="${build.dir}/cactus-webapp" antfile="build.xml" inheritall="false" target="clean"/>
        <ant dir="${build.dir}/examples-webapp" antfile="build.xml" inheritall="false" target="clean"/>
        <ant dir="${build.dir}/tiles-webapp" antfile="build.xml" inheritall="false" target="clean"/>
        <ant dir="${build.dir}/junit" antfile="build.xml" inheritall="false" target="clean"/>
        <ant dir="${build.dir}/tagunit-webapp" antfile="build.xml" inheritall="false" target="clean"/>
        <ant dir="${build.dir}/develop" antfile="build.xml" inheritall="false" target="clean"/>
    </target>

    <target name="-compile-api">
        <mkdir dir="${api.classes}"/>
        <javac srcdir="${jsfapi.src}"
               destdir="${api.classes}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="jsfapi.class.path">
        </javac>
    </target>

    <target name="-compile-share" depends="-compile-api" >
        <mkdir dir="${share.classes}"/>
        <javac srcdir="${share.src}"
               destdir="${share.classes}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="share.class.path">
        </javac>
    </target>

    <target name="-compile-impl" depends="-compile-api,-compile-share" >
        <mkdir dir="${impl.classes}"/>
        <javac srcdir="${myfaces.src}"
               destdir="${impl.classes}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="myfaces.class.path">
        </javac>
    </target>

    <target name="-compile-components" depends="-compile-api,-compile-share">
        <mkdir dir="${components.classes}"/>
        <javac srcdir="${components.src}"
               destdir="${components.classes}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="components.class.path">
        </javac>
        <tstamp>
            <format property="lastModified" pattern="yyyy-MM-dd HH:mm:ss Z"/>
        </tstamp>
    	<copy todir="${components.classes}" filtering="on">
        	<fileset dir="${components.src}" includes="**/*.properties"/>
			<filterset>
				<filter token="lastModified" value="${lastModified}"/>
			</filterset>
		</copy>
    </target>



    <target name="-compile-wml" depends="-compile-impl" >
        <mkdir dir="${wml.classes}"/>
        <javac srcdir="${share.src}"
               destdir="${share.classes}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="share.class.path">
        </javac>
    </target>


	  <!-- ============================= PREPARE XDOCLET MODULE ======================================-->
	  <target name="prepareXDoclet" description="compile XDoclet classes and create XML module descriptor">
        <mkdir dir="${xdoclet.classes}"/>
	  	<javac srcdir="${xdoclet.src}" destdir="${xdoclet.classes}" includes="**/*.java"
	           classpathref="xdoclet.classpath" />

	    <taskdef name="xdoclet" classname="xdoclet.DocletTask" classpathref="xdoclet.classpath" />
	    <xdoclet destdir="${xdoclet.classes}" verbose="false" >
	        <fileset dir="${xdoclet.src}">
	            <include name="org/apache/myfaces/xdoclet/*.java" />
	        </fileset>

	        <template templateFile="${xdoclet.src}/org/apache/myfaces/xdoclet/resources/xdoclet-xml.xdt"
	                  destinationfile="xdoclet.xml" />
	     </xdoclet>

	     <jar destfile="${myfaces-xdoclet.jar}" compress="true">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>	        <fileset dir="${xdoclet.classes}" >
	            <include name="**/*.*" />
	            <exclude name="**/xdoclet.xml" />
	        </fileset>
	        <fileset dir="${xdoclet.src}" >
	            <include name="**/*.xdt" />
	            <exclude name="**/xdoclet-xml.xdt" />
	        </fileset>
	        <metainf dir="${xdoclet.classes}" includes="xdoclet.xml" />
	     </jar>
	  </target>



	  <!-- ============================= XDOCLET - GENEREATE SOURCE CODE  =====================================-->
	  <target name="codegen" depends="prepareXDoclet" description="generate components and taglibs">
	    <taskdef name="wapfaces" classname="xdoclet.DocletTask" classpathref="xdoclet.classpath" >
	        <classpath>
	            <pathelement path="${myfaces-xdoclet.jar}" />
	        </classpath>
	    </taskdef>

	  	<mkdir dir="${generated.src}" />
	    <wapfaces destdir="${generated.src}" verbose="true"  >
	        <fileset dir="${wml.src}">
	            <include name="org/apache/myfaces/wap/def/*.java" />
	        </fileset>

	        <component destinationFile="{0}.java">
	            <packageSubstitution packages="def" substituteWith="component" />
	        </component>

	        <tag destinationFile="{0}Tag.java">
	            <packageSubstitution packages="def" substituteWith="taglib" />
	        </tag>

	        <taglib destinationFile="myfaces_wap.tld" />
	        <facesconfig destinationFile="faces-config.xml" />
	     </wapfaces>

	     <xmlvalidate warn="false" file="${generated.src}/myfaces_wap.tld">
	        <dtd publicId="-//Sun Microsystems, Inc.//DTD JSP Tag Library 1.2//EN"
	             location="res/dtds/web-jsptaglibrary_1_2.dtd" />
	     </xmlvalidate>
	     <xmlvalidate warn="false" file="${generated.src}/faces-config.xml">
	        <dtd publicId="-//Sun Microsystems, Inc.//DTD JavaServer Faces Config 1.1//EN"
	             location="res/dtds/web-facesconfig_1_1.dtd" />
	     </xmlvalidate>
	  </target>

	  <!-- ============================= BUILD TAG LIBRARY ===========================================-->
	  <target name="myfaces-wap-jar" depends="codegen"
	     description="Compile Java files, copy static files and create jar archive." >

	  	<mkdir dir="${wml.classes}"/>
	    <javac srcdir="${wml.src}" destdir="${wml.classes}" classpathref="wml.classpath.path">
	    	<include name="org/apache/myfaces/wap/base/**/*.java" />
	        <classpath>
	            <pathelement location="${wml.classes}"/>
	        </classpath>
	    </javac>


	    <javac srcdir="${generated.src}" destdir="${wml.classes}">
	    	<include name="**/*.java" />
	        <classpath refid="wml.classpath.path"/>
	    </javac>

	    <javac srcdir="${wml.src}" destdir="${wml.classes}" classpathref="wml.classpath.path">
	    	<include name="**/*.java" />
	        <exclude name="org/apache/myfaces/wap/base/**/*.java" />
	        <exclude name="org/apache/myfaces/wap/def/**/*.java" />
	        <classpath>
	            <pathelement location="${wml.classes}"/>
	        </classpath>
	    </javac>

	    <copy todir="${wml.classes}/META-INF">
	      <fileset dir="${generated.src}">
	            <include name="*.tld" />
	            <include name="faces-config.xml" />
	      </fileset>
	    </copy>

	    <jar jarfile="${myfaces-wap.jar}"  basedir="${wml.classes}">
            <!-- manifest -->
            <manifest>
                <attribute name="Built-By" value="${user.name}"/>
                <section name="myfaces.apache.org">
                    <attribute name="Implementation-Title" value="${manifest.impl.title}"/>
                    <attribute name="Implementation-Version" value="${manifest.impl.version} (${TODAY})"/>
                    <attribute name="Implementation-Vendor" value="${manifest.impl.vendor}"/>
                </section>
            </manifest>
          </jar>
	  </target>


    <target name="resolve-tld-entities">
        <mkdir dir="${resolved-tlds.dir}"/>
        <!-- resolve TLD entities (for containers that do not support entities within TLDs) -->
        <xslt basedir="${tlds.dir}"
              includes="*.tld"
              destdir="${resolved-tlds.dir}"
              style="${tlds.dir}/resolve_entities.xsl"
              extension=".tld">
            <xmlcatalog>
                <dtd publicId="-//Sun Microsystems, Inc.//DTD JSP Tag Library 1.2//EN"
                     location="${tlds.dir}/web-jsptaglibrary_1_2.dtd"/>
            </xmlcatalog>
        </xslt>
    </target>

    <target name="prepare">
        <mkdir dir="${release.dir}"/>
        <!-- remove sign script in case clean target is not run so we don't accidentally append to the old one -->
        <delete file="${sign.script}"/>
    </target>

    <target name="app-dist" depends="myfaces-jar, myfaces-wap-jar">

        <!-- build blank webapp -->
        <copy file="${conf.dir}/blank/web.xml" todir="${apps.dir}/blank/web/WEB-INF"/>
        <ant antfile="build-webapps.xml" inheritall="false" target="war">
            <property name="webapp.name" value="myfaces-blank-example"/>
            <property name="myfaces.jar" location="${myfaces.jar}"/>
            <property name="web.dir" location="${apps.dir}/blank/web"/>
            <property name="webapp.dist.dir" location="${webapp.dist.dir}"/>
            <property name="src.dir" location="${apps.dir}/src/blank/"/>
        </ant>

        <!-- build tiles webapp -->
        <copy file="${conf.dir}/tiles/web.xml" todir="${apps.dir}/tiles/web/WEB-INF"/>
        <ant antfile="build-webapps.xml" inheritall="false" target="war">
            <property name="webapp.name" value="myfaces-tiles-example"/>
            <property name="myfaces.jar" location="${myfaces.jar}"/>
            <property name="web.dir" location="${apps.dir}/tiles/web"/>
            <property name="webapp.dist.dir" location="${webapp.dist.dir}"/>
            <property name="src.dir" location="${apps.dir}/src/tiles"/>
        </ant>

        <!-- build simple webapp -->
        <copy file="${conf.dir}/web.xml" todir="${apps.dir}/simple/WEB-INF"/>
        <ant antfile="build-webapps.xml" inheritall="false" target="war">
            <property name="webapp.name" value="myfaces-simple-examples"/>
            <property name="myfaces.jar" location="${myfaces.jar}"/>
            <property name="web.dir" location="${apps.dir}/simple"/>
            <property name="webapp.dist.dir" location="${webapp.dist.dir}"/>
        </ant>

        <!-- build example webapp -->
        <copy file="${conf.dir}/web.xml" todir="${apps.dir}/examples/WEB-INF"/>
        <ant antfile="build-webapps.xml" inheritall="false" target="war">
            <property name="webapp.name" value="myfaces-examples"/>
            <property name="myfaces.jar" location="${myfaces.jar}"/>
            <property name="web.dir" location="${apps.dir}/examples"/>
            <property name="webapp.dist.dir" location="${webapp.dist.dir}"/>
        </ant>

        <!-- build wap webapp -->
        <copy file="${conf.dir}/wap/web.xml" todir="${apps.dir}/wap/WEB-INF"/>
        <ant antfile="build-webapps.xml" inheritall="false" target="war">
            <property name="webapp.name" value="myfaces-wap-example"/>
            <property name="myfaces.jar" location="${myfaces.jar}"/>
            <property name="web.dir" location="${apps.dir}/wap"/>
            <property name="webapp.dist.dir" location="${webapp.dist.dir}"/>
            <property name="src.dir" location="${apps.dir}/src/wap"/>
            <property name="myfaces-wap.jar" location="${myfaces-wap.jar}"/>
        </ant>

    </target>

    <target name="app-release" depends="prepare, app-dist">

        <property name="app.release.tgz" value="${release.dir}/${app.release.bundle}.tgz"/>
        <property name="app.release.zip" value="${release.dir}/${app.release.bundle}.zip"/>

        <tar destfile="${app.release.tgz}" compression="gzip" >
            <tarfileset prefix="${app.release.bundle}" dir="${webapp.dist.dir}"/>
        </tar>
        
        <checksum file="${app.release.tgz}" forceOverwrite="yes" fileext=".md5"/>

        <zip destfile="${app.release.zip}" compress="true">
            <zipfileset prefix="${app.release.bundle}" dir="${webapp.dist.dir}"/>
        </zip>
        
        <checksum file="${app.release.zip}" forceOverwrite="yes" fileext=".md5"/>        
        
        <!-- generate/append script for pgp signing of bundle -->
        <echo file="${sign.script}" append="true">
        gpg -o ${app.release.tgz}.asc --detach-sig ${app.release.tgz}
        gpg --verify ${app.release.tgz}.asc ${app.release.tgz}
        gpg -o ${app.release.zip}.asc --detach-sig ${app.release.zip}
        gpg --verify ${app.release.zip}.asc ${app.release.zip}
        </echo>                

    </target>

    <target name="release" depends="prepare, src-release, bin-release, app-release"/>

</project>

