<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE project [
    <!ENTITY tomcat-build SYSTEM "file:../tomcat/tomcat-build.xmlf">
]>
<project name="myfaces-cactus-tests" default="cactus">

    <property environment="env"/>
	
    <!-- Constants -->
    <property name="project.dir" location="${basedir}/../.."/>
    <property name="cactus.dir" location="${project.dir}/src/cactus"/>
    <property name="cactus.src.dir" location="${cactus.dir}"/>
	<property name="cactus.web.dir" location="${cactus.dir}/web"/>

    <!-- Properties -->
    <property file="../build.properties"/>
    <property file="../build.properties.default"/>

    <!-- Temporary dir. May be overridden in build.properties -->
    <property name="temp.dir" location="${env.TEMP}"/>

    <!-- Output dirs and files -->
    <property name="cactus.classes.dir" location="${temp.dir}/cactus"/>
    <property name="cactus.results.dir" location="${test.results.dir}/cactus"/>
    <property name="tests.jar" location="${temp.dir}/myfaces-cactus-tests.jar"/>
    <property name="tests.war" location="${temp.dir}/myfaces-cactus-tests.war"/>

    <!-- Tomcat -->
    <property name="tomcat.war.file" location="${tests.war}"/>
    <property name="tomcat.context.path" value="/myfaces-cactus-tests"/>

    <!-- cactus classpath for compiling -->
    <path id="cactus.class.path">
        <pathelement location="${servlet.jar}"/>
        <pathelement location="${jsp-api.jar}"/>
        <pathelement location="${jstl.jar}"/>
        <pathelement location="${myfaces.jar}"/>
        <pathelement location="${commons-logging.jar}"/>
        <fileset dir="${cactus.lib.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>


    <target name="cactus" depends="-war">
        <antcall target="tomcat-deploy-app"/>
        <antcall target="-tomcat-cactus-tests"/>
        <antcall target="tomcat-undeploy-app"/>
    </target>

	<target name="clean"
            description="deletes all files that were built">
		<delete dir="${cactus.results.dir}"/>
		<delete dir="${cactus.classes.dir}"/>
		<delete file="${tests.jar}"/>
		<delete file="${tests.war}"/>
    </target>


    <target name="-compile"
            depends="-myfaces-jar"
            description="compiles the examples java classes to WEB-INF/classes and copies all needed libs to WEB-INF/lib">
        <mkdir dir="${cactus.classes.dir}"/>
        <javac srcdir="${cactus.src.dir}"
               destdir="${cactus.classes.dir}"
               optimize="${javac.optimize}"
               debug="${javac.debug}"
               classpathref="cactus.class.path">
        </javac>
    	<jar basedir="${cactus.classes.dir}" destfile="${tests.jar}"/>
    </target>

    <target name="-war" depends="-compile"
            description="creates the test war file">
        <tstamp>
            <format property="TODAY" pattern="yyyy-MM-dd HH:mm" locale="en"/>
        </tstamp>
        <war destfile="${tests.war}"
             webxml="${project.dir}/build/cactus-webapp/web.xml">
            <manifest>
                <section name="myfaces.sourceforge.net">
                    <attribute name="Implementation-Title" value="MyFaces - Cactus Tests"/>
                    <attribute name="Implementation-Version" value="${TODAY}"/>
                    <attribute name="Implementation-Vendor" value="MyFaces Project Team"/>
                </section>
            </manifest>
            <lib file="${tests.jar}"/>
            <lib file="${commons-el.jar}"/>
        	<lib file="${commons-logging.jar}"/>
            <lib file="${commons-codec.jar}"/>
            <lib file="${commons-fileupload.jar}"/>
        	<lib file="${cos.jar}"/>
            <lib file="${jstl.jar}"/>
            <lib file="${myfaces.jar}"/>
            <lib file="${log4j.jar}"/>
            <lib dir="${cactus.lib.dir}">
                <include name="*.jar"/>
                <exclude name="cactus-ant-1.5.jar"/>
                <exclude name="commons-logging-1.0.3.jar"/>
            </lib>
            <fileset dir="${cactus.web.dir}"/>
        </war>
    </target>

	<target name="-tomcat-cactus-tests" depends="-war"
            description="run the cactus tests">
        <mkdir dir="${cactus.results.dir}/test-reports/xml"/>
        <mkdir dir="${cactus.results.dir}/test-reports/html"/>
        <junit fork="true">
            <classpath refid="cactus.class.path"/>
      	    <classpath>
              <pathelement path="${basedir}"/>
              <pathelement path="${cactus.classes.dir}"/>
          	</classpath>
            <batchtest toDir="${cactus.results.dir}/test-reports/xml">
                <fileset dir="${cactus.classes.dir}">
                    <include name="**/*CactusTest.class"/>
               	</fileset>
            </batchtest>
            <formatter type="xml"/>
        </junit>
	    <junitreport>
	        <fileset dir="${cactus.results.dir}/test-reports/xml">
		        <include name="TEST-*.xml"/>
		    </fileset>
		    <report toDir="${cactus.results.dir}/test-reports/html"/>
	    </junitreport>
    </target>

    &tomcat-build;

    <target name="-myfaces-jar" description="create myfaces.jar if necessary" >
        <available file="${myfaces.jar}" property="myfaces.jar.available"/>
        <antcall target="-create-myfaces-jar"/>
    </target>

    <target name="-create-myfaces-jar" unless="myfaces.jar.available"
            description="creates myfaces.jar via main buildfile" >
        <ant dir="${project.dir}/build" antfile="build.xml" target="myfaces-jar" inheritall="false"/>
    </target>

</project>
